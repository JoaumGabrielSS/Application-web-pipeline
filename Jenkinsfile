pipeline {
    agent any
    
    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        TF_VAR_project_name = 'match3-game'
        SSH_KEY_PATH = 'terraform/candy-crush-game-key.pem'
        DEPLOY_SCRIPT = 'scripts/deploy-application.sh'
    }
    
    parameters {
        choice(
            name: 'ACTION',
            choices: ['deploy', 'destroy', 'plan'],
            description: 'A√ß√£o a ser executada no pipeline'
        )
        booleanParam(
            name: 'FORCE_RECREATE',
            defaultValue: false,
            description: 'For√ßar recria√ß√£o da infraestrutura'
        )
        string(
            name: 'BRANCH',
            defaultValue: 'main',
            description: 'Branch do reposit√≥rio para deploy'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'Pular valida√ß√µes e testes'
        )
    }
    
    stages {
        stage('Checkout & Prepare') {
            steps {
                echo "Fazendo checkout do c√≥digo..."
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.BRANCH}"]],
                    userRemoteConfigs: [[url: env.GIT_URL]]
                ])
                
                script {
                    if (isUnix()) {
                        sh '''
                            echo "Configurando permiss√µes Linux..."
                            chmod 600 ${SSH_KEY_PATH} || echo "Chave SSH ser√° criada pelo Terraform"
                            chmod +x ${DEPLOY_SCRIPT}
                            chmod +x scripts/setup.sh
                        '''
                    } else {
                        bat '''
                            echo "Configurando permiss√µes Windows..."
                            echo "Chave SSH e scripts prontos para uso"
                        '''
                    }
                }
            }
        }
        
        stage('Code Validation') {
            when {
                expression { !params.SKIP_TESTS }
            }
            parallel {
                stage('Terraform Validate') {
                    steps {
                        dir('terraform') {
                            sh '''
                                echo "Validando sintaxe do Terraform..."
                                terraform fmt -check=true -diff=true
                                terraform validate
                            '''
                        }
                    }
                }
                stage('Application Structure') {
                    steps {
                        sh '''
                            echo "Verificando estrutura da aplica√ß√£o..."
                            test -f game-app/docker-compose.yml || exit 1
                            test -f game-app/Dockerfile || exit 1
                            test -f game-app/src/index.html || exit 1
                            echo "Estrutura da aplica√ß√£o OK!"
                        '''
                    }
                }
                stage('Scripts Validation') {
                    steps {
                        sh '''
                            echo "Validando scripts de deploy..."
                            bash -n ${DEPLOY_SCRIPT}
                            bash -n scripts/setup.sh
                            echo "Scripts validados com sucesso!"
                        '''
                    }
                }
            }
        }
        
        stage('Terraform Initialize') {
            steps {
                dir('terraform') {
                    sh '''
                        echo "Inicializando Terraform..."
                        terraform init -upgrade
                        terraform version
                    '''
                }
            }
        }
        
        stage('Infrastructure Planning') {
            when {
                anyOf {
                    expression { params.ACTION == 'plan' }
                    expression { params.ACTION == 'deploy' }
                }
            }
            steps {
                dir('terraform') {
                    sh '''
                        echo "Planejando infraestrutura..."
                        terraform plan -out=tfplan \
                            -var="project_name=${TF_VAR_project_name}" \
                            -detailed-exitcode
                        
                        echo "Salvando plano para revis√£o..."
                        terraform show -no-color tfplan > plan-output.txt
                    '''
                    
                    archiveArtifacts artifacts: 'tfplan,plan-output.txt', fingerprint: true
                }
            }
        }
        
        stage('Deploy Infrastructure') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    def userApproval = true
                    
                    if (!params.FORCE_RECREATE) {
                        try {
                            timeout(time: 15, unit: 'MINUTES') {
                                userApproval = input(
                                    message: 'Confirma o deploy da infraestrutura AWS?',
                                    parameters: [
                                        booleanParam(
                                            name: 'CONFIRM_DEPLOY',
                                            defaultValue: false,
                                            description: 'Confirmar cria√ß√£o da infraestrutura'
                                        )
                                    ]
                                )
                            }
                        } catch (err) {
                            echo "Timeout na confirma√ß√£o - cancelando deploy"
                            currentBuild.result = 'ABORTED'
                            return
                        }
                    }
                    
                    if (userApproval || params.FORCE_RECREATE) {
                        dir('terraform') {
                            sh '''
                                echo "üèóÔ∏è Aplicando infraestrutura..."
                                terraform apply -auto-approve tfplan
                                
                                echo "üìù Capturando outputs da infraestrutura..."
                                terraform output -raw server_ip > ../server_ip.txt
                                terraform output -raw server_public_ip > ../server_public_ip.txt
                                
                                echo "‚úÖ Infraestrutura criada com sucesso!"
                                echo "üåê IP do servidor: $(cat ../server_ip.txt)"
                            '''
                        }
                    } else {
                        echo "‚ùå Deploy cancelado pelo usu√°rio"
                        currentBuild.result = 'ABORTED'
                    }
                }
            }
        }
        
        stage('‚è≥ Wait for Instance Ready') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    def serverIp = readFile('server_ip.txt').trim()
                    echo "‚è≥ Aguardando inst√¢ncia ${serverIp} ficar pronta..."
                    
                    sh """
                        echo "üîç Testando conectividade SSH..."
                        for i in {1..20}; do
                            if ssh -i ${SSH_KEY_PATH} -o ConnectTimeout=10 -o StrictHostKeyChecking=no ec2-user@${serverIp} 'echo "SSH OK"' 2>/dev/null; then
                                echo "‚úÖ Inst√¢ncia acess√≠vel via SSH!"
                                break
                            fi
                            echo "‚è≥ Tentativa \$i/20 - aguardando 30 segundos..."
                            sleep 30
                        done
                        
                        echo "üêã Verificando Docker na inst√¢ncia..."
                        ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ec2-user@${serverIp} 'docker --version && docker-compose --version'
                    """
                }
            }
        }
        
        stage('üéÆ Deploy Application') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    def serverIp = readFile('server_ip.txt').trim()
                    echo "üöÄ Iniciando deploy da aplica√ß√£o para ${serverIp}..."
                    
                    sh """
                        echo "üéÆ Executando deploy profissional..."
                        ${DEPLOY_SCRIPT} ${serverIp} ${SSH_KEY_PATH} game-app
                    """
                }
            }
        }
        
        stage('üß™ Application Health Check') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    def serverIp = readFile('server_ip.txt').trim()
                    echo "üîç Executando health check completo..."
                    
                    sh """
                        echo "üåê Testando aplica√ß√£o web..."
                        for i in {1..15}; do
                            if curl -f -s -m 10 http://${serverIp} >/dev/null 2>&1; then
                                echo "‚úÖ Aplica√ß√£o web respondendo!"
                                break
                            fi
                            echo "‚è≥ Tentativa \$i/15 - aguardando aplica√ß√£o inicializar..."
                            sleep 20
                        done
                        
                        echo "üîß Testando API backend..."
                        if curl -f -s -m 10 http://${serverIp}:3000/health >/dev/null 2>&1; then
                            echo "‚úÖ API backend funcionando!"
                        else
                            echo "‚ö†Ô∏è API backend n√£o respondeu (pode estar inicializando)"
                        fi
                        
                        echo "üêã Verificando containers Docker..."
                        ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ec2-user@${serverIp} 'cd /opt/game-app && docker-compose ps'
                        
                        echo "üìä Status geral do sistema:"
                        ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ec2-user@${serverIp} 'df -h / && free -h && uptime'
                    """
                }
            }
        }
        
        stage('üóëÔ∏è Destroy Infrastructure') {
            when {
                expression { params.ACTION == 'destroy' }
            }
            steps {
                script {
                    def confirmation = input(
                        message: '‚ö†Ô∏è DESTRUI√á√ÉO TOTAL DA INFRAESTRUTURA ‚ö†Ô∏è',
                        parameters: [
                            string(
                                name: 'DESTROY_CONFIRMATION',
                                defaultValue: '',
                                description: 'Digite "DESTROY-ALL" para confirmar a destrui√ß√£o completa'
                            )
                        ]
                    )
                    
                    if (confirmation == 'DESTROY-ALL') {
                        dir('terraform') {
                            sh '''
                                echo "üóëÔ∏è Destruindo infraestrutura..."
                                terraform destroy -auto-approve \
                                    -var="project_name=${TF_VAR_project_name}"
                                
                                echo "‚úÖ Infraestrutura destru√≠da com sucesso!"
                            '''
                        }
                        
                        // Limpar arquivos tempor√°rios
                        sh '''
                            rm -f server_ip.txt server_public_ip.txt
                            echo "üßπ Arquivos tempor√°rios removidos"
                        '''
                    } else {
                        error('‚ùå Confirma√ß√£o inv√°lida. Destrui√ß√£o cancelada por seguran√ßa.')
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "üßπ Executando limpeza p√≥s-pipeline..."
            
            // Limpar arquivos tempor√°rios sens√≠veis
            sh '''
                rm -f terraform/tfplan
                rm -f terraform/*.log
                find . -name "*.tmp" -delete 2>/dev/null || true
            '''
            
            // Arquivar logs importantes
            archiveArtifacts artifacts: 'terraform/plan-output.txt', allowEmptyArchive: true
            archiveArtifacts artifacts: '*.log', allowEmptyArchive: true
        }
        
        success {
            script {
                if (params.ACTION == 'deploy') {
                    def serverIp = ''
                    try {
                        serverIp = readFile('server_ip.txt').trim()
                    } catch (Exception e) {
                        serverIp = 'N/A'
                    }
                    
                    echo """
                    üéâüéâüéâ PIPELINE DE PRODU√á√ÉO CONCLU√çDO COM SUCESSO! üéâüéâüéâ
                    
                    üéÆ SEU MATCH-3 GAME EST√Å FUNCIONANDO:
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    üåê Aplica√ß√£o Web: http://${serverIp}
                    üîß API Backend:   http://${serverIp}:3000
                    üè• Health Check:  http://${serverIp}:3000/health
                    
                    üîê ACESSO SSH:
                    ssh -i candy-crush-game-key.pem ec2-user@${serverIp}
                    
                    üìä MONITORAMENTO:
                    - Logs Docker: /opt/game-app/logs/
                    - Status: docker-compose ps
                    - Recursos: htop / df -h
                    
                    üöÄ PR√ìXIMOS PASSOS:
                    - Teste o jogo completo
                    - Configure DNS personalizado
                    - Adicione HTTPS com SSL
                    - Configure backup autom√°tico
                    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    """
                } else if (params.ACTION == 'destroy') {
                    echo """
                    ‚úÖ INFRAESTRUTURA DESTRU√çDA COM SUCESSO!
                    
                    üóëÔ∏è Todos os recursos AWS foram removidos
                    üí∞ N√£o haver√° mais cobran√ßa pelos recursos
                    üîÑ Execute 'deploy' para recriar quando necess√°rio
                    """
                } else if (params.ACTION == 'plan') {
                    echo """
                    ‚úÖ PLANEJAMENTO CONCLU√çDO!
                    
                    üìã Revise o plano em: plan-output.txt
                    üöÄ Execute 'deploy' para aplicar as mudan√ßas
                    """
                }
            }
        }
        
        failure {
            echo """
            ‚ùå‚ùå‚ùå PIPELINE FALHOU! ‚ùå‚ùå‚ùå
            
            üîç DIAGN√ìSTICO R√ÅPIDO:
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            1. Verifique credenciais AWS (aws sts get-caller-identity)
            2. Confirme chave SSH: ${SSH_KEY_PATH}
            3. Valide regi√£o AWS: ${AWS_DEFAULT_REGION}
            4. Verifique logs do Terraform acima
            
            üí° PROBLEMAS COMUNS:
            - Credenciais AWS expiradas
            - Limite de recursos atingido
            - Security groups conflitantes
            - Chave SSH n√£o encontrada
            
            üÜò SUPORTE:
            - Logs arquivados para an√°lise
            - Execute 'plan' para diagnosticar
            - Verifique console AWS para conflitos
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            """
        }
        
        aborted {
            echo """
            ‚è∏Ô∏è PIPELINE CANCELADO PELO USU√ÅRIO
            
            üîÑ Voc√™ pode executar novamente quando necess√°rio
            üìä Execute 'plan' para revisar mudan√ßas antes do deploy
            """
        }
    }
}